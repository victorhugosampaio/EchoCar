/**
 * @file display.c
 * @author victorhugosampaio
 * @brief SSD1306 display driver.
 * @version 0.1
 * @date 01-15-2025
 *
 * @note: Based on https://github.com/bokfink/esp32-zephyr-ssd1306-tutorialzephyr_esp32_ssd1306_yt5/tree/master
 * @note: Font: https://github.com/lynniemagoo/oled-font-pack/blob/master/fonts/8x8/tiny-font-8x8.js
 *
 * @copyright Copyright (c) 2025
 *
 */


#include "display.h"

#include <errno.h>
#include <stdint.h>
#include <zephyr/device.h>
#include <zephyr/drivers/display.h>
#include <zephyr/kernel.h>
#include <zephyr/logging/log.h>

/**
 * @brief OLED display specs.
 */
#define DISPLAY_WIDTH 128
#define DISPLAY_HEIGHT 64

/**
 * @brief Display maximum buffer size.
 */
#define DISPLAY_MAX_BUFFER_SIZE DISPLAY_WIDTH * DISPLAY_HEIGHT

/**
 * @brief Font char size.
 */
#define CHAR_WIDTH 8
#define CHAR_HEIGHT 8

/**
 * @brief String maximum width.
 */
#define STRING_MAX_WIDTH DISPLAY_WIDTH / CHAR_WIDTH

LOG_MODULE_REGISTER(display);

/**
 * @brief Add a char to the display buffer.
 *
 * @param c Char to be added. 
 */
static void add_char(char c);

/**
 * @brief Clear the display buffer.
 */
static void clr_display_buf(void);

/**
 * @brief Container that holds the display device.
 */
static const struct device *display = DEVICE_DT_GET(DT_NODELABEL(ssd1306));

/**
 * @brief Display buffer.
 */
static uint8_t display_buf[DISPLAY_MAX_BUFFER_SIZE];

/**
 * @brief Display buffer index.
 */
static uint16_t buf_idx;

/**
 * @brief Container that holds the display buffer params.
 */
static struct display_buffer_descriptor display_buf_desc = {
    .width = DISPLAY_WIDTH,
    .height = DISPLAY_HEIGHT,
    .buf_size = DISPLAY_MAX_BUFFER_SIZE,
    .pitch = DISPLAY_WIDTH,
};

/**
 * @brief 8x8 font.
 */
static const uint8_t font[91 * CHAR_WIDTH] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // <space>
    0x00,0x00,0x06,0x5f,0x5f,0x06,0x00,0x00,  // !
    0x00,0x03,0x07,0x00,0x00,0x07,0x03,0x00,  // "
    0x14,0x7f,0x7f,0x14,0x7f,0x7f,0x14,0x00,  // #
    0x00,0x24,0x2e,0x6b,0x6b,0x3a,0x12,0x00,  // $
    0x46,0x66,0x30,0x18,0x0c,0x66,0x62,0x00,  // %
    0x30,0x7a,0x4f,0x5d,0x37,0x7a,0x48,0x00,  // &
    0x00,0x00,0x04,0x07,0x03,0x00,0x00,0x00,  // '
    0x00,0x00,0x1c,0x3e,0x63,0x41,0x00,0x00,  // (
    0x00,0x00,0x41,0x63,0x3e,0x1c,0x00,0x00,  // )
    0x08,0x2a,0x3e,0x1c,0x1c,0x3e,0x2a,0x08,  // *
    0x00,0x08,0x08,0x3e,0x3e,0x08,0x08,0x00,  // +
    0x00,0x00,0x80,0xe0,0x60,0x00,0x00,0x00,  // ,
    0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,  // -
    0x00,0x00,0x00,0x60,0x60,0x00,0x00,0x00,  // .
    0x60,0x30,0x18,0x0c,0x06,0x03,0x01,0x00,  // /

    0x3e,0x7f,0x51,0x49,0x45,0x7f,0x3e,0x00,  // 0
    0x00,0x40,0x42,0x7f,0x7f,0x40,0x40,0x00,  // 1
    0x42,0x63,0x71,0x59,0x49,0x6f,0x66,0x00,  // 2
    0x22,0x63,0x49,0x49,0x49,0x7f,0x36,0x00,  // 3
    0x18,0x1c,0x16,0x53,0x7f,0x7f,0x50,0x00,  // 4
    0x2f,0x6f,0x49,0x49,0x49,0x79,0x31,0x00,  // 5
    0x3c,0x7e,0x4b,0x49,0x49,0x78,0x30,0x00,  // 6
    0x03,0x03,0x71,0x79,0x0d,0x07,0x03,0x00,  // 7
    0x36,0x7f,0x49,0x49,0x49,0x7f,0x36,0x00,  // 8
    0x06,0x4f,0x49,0x49,0x69,0x3f,0x1e,0x00,  // 9
    0x00,0x00,0x00,0x66,0x66,0x00,0x00,0x00,  // :
    0x00,0x00,0x80,0xe6,0x66,0x00,0x00,0x00,  // ;
    0x00,0x00,0x08,0x1c,0x36,0x63,0x41,0x00,  // <
    0x00,0x24,0x24,0x24,0x24,0x24,0x24,0x00,  // =
    0x00,0x41,0x63,0x36,0x1c,0x08,0x00,0x00,  // >
    0x02,0x03,0x01,0x59,0x5d,0x07,0x02,0x00,  // ?

    0x3e,0x7f,0x41,0x5d,0x5d,0x1f,0x1e,0x00,  // @
    0x7c,0x7e,0x0b,0x09,0x0b,0x7e,0x7c,0x00,  // A
    0x41,0x7f,0x7f,0x49,0x49,0x7f,0x36,0x00,  // B
    0x1c,0x3e,0x63,0x41,0x41,0x63,0x22,0x00,  // C
    0x41,0x7f,0x7f,0x41,0x63,0x3e,0x1c,0x00,  // D
    0x41,0x7f,0x7f,0x49,0x5d,0x41,0x63,0x00,  // E
    0x41,0x7f,0x7f,0x49,0x1d,0x01,0x03,0x00,  // F
    0x1c,0x3e,0x63,0x41,0x51,0x33,0x72,0x00,  // G
    0x7f,0x7f,0x08,0x08,0x08,0x7f,0x7f,0x00,  // H
    0x00,0x00,0x41,0x7f,0x7f,0x41,0x00,0x00,  // I
    0x30,0x70,0x40,0x41,0x7f,0x3f,0x01,0x00,  // J
    0x41,0x7f,0x7f,0x08,0x1c,0x77,0x63,0x00,  // K
    0x41,0x7f,0x7f,0x41,0x40,0x60,0x70,0x00,  // L
    0x7f,0x7f,0x0e,0x1c,0x0e,0x7f,0x7f,0x00,  // M
    0x7f,0x7f,0x06,0x0c,0x18,0x7f,0x7f,0x00,  // N
    0x3e,0x7f,0x41,0x41,0x41,0x7f,0x3e,0x00,  // O

    0x41,0x7f,0x7f,0x49,0x09,0x0f,0x06,0x00,  // P
    0x3e,0x7f,0x41,0x41,0xe1,0xff,0xbe,0x00,  // Q
    0x41,0x7f,0x7f,0x09,0x19,0x7f,0x66,0x00,  // R
    0x22,0x67,0x4d,0x49,0x59,0x73,0x22,0x00,  // S
    0x00,0x07,0x43,0x7f,0x7f,0x43,0x07,0x00,  // T
    0x3f,0x7f,0x40,0x40,0x40,0x7f,0x3f,0x00,  // U
    0x1f,0x3f,0x60,0x40,0x60,0x3f,0x1f,0x00,  // V
    0x3f,0x7f,0x60,0x38,0x60,0x7f,0x3f,0x00,  // W
    0x63,0x77,0x1c,0x08,0x1c,0x77,0x63,0x00,  // X
    0x00,0x07,0x4f,0x78,0x78,0x4f,0x07,0x00,  // Y
    0x47,0x63,0x71,0x59,0x4d,0x67,0x73,0x00,  // Z
    0x00,0x00,0x7f,0x7f,0x41,0x41,0x00,0x00,  // [
    0x01,0x03,0x06,0x0c,0x18,0x30,0x60,0x00,  // <backslash>
    0x00,0x00,0x41,0x41,0x7f,0x7f,0x00,0x00,  // ]
    0x08,0x0c,0x06,0x03,0x06,0x0c,0x08,0x00,  // ^
    0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,  // _

    0x00,0x00,0x01,0x03,0x06,0x04,0x00,0x00,  // `
    0x20,0x74,0x54,0x54,0x3c,0x78,0x40,0x00,  // a
    0x41,0x7f,0x3f,0x44,0x44,0x7c,0x38,0x00,  // b
    0x38,0x7c,0x44,0x44,0x44,0x6c,0x28,0x00,  // c
    0x38,0x7c,0x44,0x45,0x3f,0x7f,0x40,0x00,  // d
    0x38,0x7c,0x54,0x54,0x54,0x5c,0x18,0x00,  // e
    0x48,0x7e,0x7f,0x49,0x09,0x03,0x02,0x00,  // f
    0x98,0xbc,0xa4,0xa4,0xf8,0x7c,0x04,0x00,  // g
    0x41,0x7f,0x7f,0x08,0x04,0x7c,0x78,0x00,  // h
    0x00,0x00,0x44,0x7d,0x7d,0x40,0x00,0x00,  // i
    0x00,0x60,0xe0,0x80,0x80,0xfd,0x7d,0x00,  // j
    0x41,0x7f,0x7f,0x10,0x38,0x6c,0x44,0x00,  // k
    0x00,0x00,0x41,0x7f,0x7f,0x40,0x00,0x00,  // l
    0x7c,0x7c,0x0c,0x78,0x0c,0x7c,0x78,0x00,  // m
    0x04,0x7c,0x78,0x04,0x04,0x7c,0x78,0x00,  // n
    0x38,0x7c,0x44,0x44,0x44,0x7c,0x38,0x00,  // o

    0x84,0xfc,0xf8,0xa4,0x24,0x3c,0x18,0x00,  // p
    0x18,0x3c,0x24,0xa4,0xf8,0xfc,0x84,0x00,  // q
    0x44,0x7c,0x78,0x4c,0x04,0x0c,0x08,0x00,  // r
    0x48,0x5c,0x54,0x54,0x54,0x74,0x24,0x00,  // s
    0x04,0x04,0x3f,0x7f,0x44,0x64,0x20,0x00,  // t
    0x3c,0x7c,0x40,0x40,0x3c,0x7c,0x40,0x00,  // u
    0x1c,0x3c,0x60,0x40,0x60,0x3c,0x1c,0x00,  // v
    0x3c,0x7c,0x60,0x38,0x60,0x7c,0x3c,0x00,  // w
    0x44,0x6c,0x38,0x10,0x38,0x6c,0x44,0x00,  // x
    0x9c,0xbc,0xa0,0xa0,0xa0,0xfc,0x7c,0x00,  // y
    0x00,0x4c,0x64,0x74,0x5c,0x4c,0x64,0x00,  // z
};

int display_init(void) {
    if (display == NULL) {
        LOG_ERR("display pointer is NULL");
        return -EFAULT;
    }

    if (!device_is_ready(display)) {
        LOG_ERR("display is not ready");
        return -EBUSY;
    }

    clr_display_buf();

    return 0;
}

void add_string(char *str) {
    uint8_t idx = 0;

    for (uint8_t pos = 0; str[pos] != '\0'; pos++) {
        if (str[pos] == '\n') {
            buf_idx += CHAR_WIDTH * (STRING_MAX_WIDTH - idx);
            idx = 0;
            continue;
        }

        if (idx >= STRING_MAX_WIDTH) {
            continue;
        }

        add_char(str[pos]);
        idx++;
    }
}

int display_print(void) {
    if (display_write(display, 0, 0, &display_buf_desc, display_buf) != 0) {
        LOG_ERR("could not write to display");
        return -EBUSY;
    }

   clr_display_buf();

    return 0;
}

static void add_char(char c) {
    uint8_t index = c - ' ';
    uint16_t start = index * CHAR_WIDTH;

    if (buf_idx >= DISPLAY_MAX_BUFFER_SIZE) {
        return;
    }

    for (uint8_t i = 0; i < CHAR_WIDTH; i++) {
        display_buf[buf_idx] = font[start + i];
        buf_idx++;
    }
}

static void clr_display_buf(void) {
     buf_idx = 0;

    for (uint16_t i = 0; i < DISPLAY_MAX_BUFFER_SIZE; i++) {
        display_buf[i] = 0x00;
    }
}